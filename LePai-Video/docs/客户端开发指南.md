# 乐拍视界 (LePai Vision) · 客户端开发指南

**版本**: v1.0
**适用框架**: Qt 6.5+ / QML / C++17
**核心依赖**: `QtNetwork`, `QtMultimedia`, `QtConcurrent`

---

## 1. 网络架构与寻址 (Topology)

客户端需同时维护三条网络通道。请在 `config.json` 中配置以下三个 Base URL，严禁在代码中写死 IP。

| 通道名称 | 对应服务 | 协议 | 端口 | Base URL 示例 | 用途 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **API 通道** | PC-2 (Gateway) | HTTP | **8000** | `http://192.168.1.X:8000` | 业务逻辑 (登录/刷视频/点赞/关注) |
| **上传通道** | PC-1 (MinIO) | HTTP | **9000** | `http://192.168.1.X:9000` | **仅用于**上传原始视频文件 |
| **媒体通道** | PC-3 (CDN) | HTTP | **8001** | `http://192.168.1.X:8001` | 播放 m3u8 流、加载封面图片 |

---

## 2. 核心交互规范 (Interaction Specs)

### 2.1 全局约定

1.  **请求头 (Request Headers)**:
    *   API 通道所有 POST 请求必须包含: `Content-Type: application/json`
    *   **鉴权**: 除登录/注册外，所有 API 请求必须包含 Header: `Authorization: Bearer <TOKEN>`
2.  **响应格式 (Response)**:
    *   成功: HTTP 200 + JSON `{"code": 200, "data": {...}}`
    *   业务错误: HTTP 4xx/5xx + JSON `{"code": 4xx, "message": "错误原因"}`
3.  **Qt 实现建议**:
    *   封装 `NetworkManager` 单例。
    *   使用 `QNetworkRequest::setRawHeader` 统一注入 Token。
    *   监听 `QNetworkReply::errorOccurred` 信号，统一处理 **401 Unauthorized** (跳转登录页)。

---

### 2.2 用户体系交互

#### A. 登录 (Login)
*   **Endpoint**: `POST /api/user/login`
*   **Body**:
    ```json
    { "username": "admin", "password": "123" }
    ```
*   **Success (200)**:
    ```json
    {
        "code": 200, 
        "token": "uuid-token-string", // ⚠️ 必须存入 QSettings/SQLite
        "user": { "id": "...", "username": "...", "avatar_url": "..." } // 存入 UserContext 单例
    }
    ```

#### B. 个人主页/用户画像 (User Profile)
*   **Endpoint**: `GET /api/user/info?user_id={target_id}`
    *   *Case 1 查自己*: 不传 `user_id` 参数。
    *   *Case 2 查别人*: 传入 `user_id` 参数。
*   **Success (200)**:
    ```json
    {
        "code": 200,
        "data": {
            "id": "u1",
            "username": "Jack",
            "avatar_url": "http://PC-3:8001/...",
            "following_count": 10,  // 关注数
            "follower_count": 50,   // 粉丝数
            "is_followed": true     // 我是否关注了他 (仅在查别人时有效)
        }
    }
    ```

#### C. 修改用户名
*   **Endpoint**: `POST /api/user/update_name`
*   **Body**: `{ "new_name": "NewName" }`
*   **Client Logic**: 成功后需更新本地 `UserContext` 中的用户名，并刷新个人主页 UI。

---

### 2.3 社交互动 (Social Actions)

> **💡 开发技巧**: 社交操作建议使用 **乐观 UI 更新 (Optimistic UI Update)** 策略。即：用户点击后，界面先变色/+1，然后再发网络请求。如果请求失败，再悄悄变回来并弹 Toast 报错。

#### A. 关注/取关 (Follow)
*   **Endpoint**: `POST /api/user/follow`
*   **Body**:
    ```json
    {
        "target_id": "u2", // 对方的 ID
        "action": true     // true=关注, false=取关
    }
    ```
*   **Response**: `{"code": 200, "message": "Followed"}`

#### B. 点赞/取消点赞 (Like)
*   **Endpoint**: `POST /api/video/like`
*   **Body**:
    ```json
    {
        "video_id": "v1",
        "action": true     // true=点赞, false=取消
    }
    ```
*   **Response**:
    ```json
    {
        "code": 200, 
        "like_count": 101 // 服务端返回最新计数，建议用此值校准界面
    }
    ```

---

### 2.4 视频流与播放 (Feed & Playback)

#### A. 获取推荐流 (Discovery Feed)
*   **Endpoint**: `GET /api/feed/discovery?limit=10&offset={N}`
*   **Success (200)**:
    ```json
    {
        "code": 200,
        "next_offset": 10, // ⚠️ 下一次请求必须带上这个值
        "data": [
            {
                "id": "v1",
                "url": "http://PC-3:8001/public/videos/v1/index.m3u8", // HLS 播放地址
                "cover_url": "http://PC-3:8001/public/covers/v1.jpg",
                "author": "Alice",
                "author_avatar": "...",
                "is_liked": true,    // UI 显示红心
                "is_followed": false // UI 显示关注按钮
            },
            ...
        ]
    }
    ```
*   **无限流逻辑**: 
    1.  如果 `data` 不为空，将其 Append 到 `QAbstractListModel`。
    2.  记录 `next_offset`。
    3.  当 ListView 滑动到底部时，用新的 `offset` 发起下一次请求。

---

### 2.5 视频发布全流程 (Critical Path)

这是最容易出错的环节，请务必分为**串行**的两步。

#### 步骤 1: 直传 MinIO (PUT)
*   **逻辑**: 绕过 API 网关，直接把文件扔给存储服务器。
*   **URL 构造**: `http://PC-1:9000/temp/{UUID}.mp4`
    *   *UUID*: 客户端本地生成 (如 `QUuid::createUuid().toString()`)，**去掉大括号**。
*   **Method**: `PUT`
*   **Headers**:
    *   `Content-Type`: `video/mp4` (注意：不是 form-data，是 raw binary)
    *   **鉴权**: 由于模拟环境 MinIO 配置较简，若 `temp` 桶设为 private，建议在客户端 Config 中配置临时的 MinIO `accessKey/secretKey` 计算签名，**或者** (简单做法) 请服务端将 `temp` 桶策略设为 public upload (仅限内网模拟)。
*   **Body**: 文件二进制数据。
*   **Qt 关键代码**:
    ```cpp
    QFile *file = new QFile(localPath);
    file->open(QIODevice::ReadOnly);
    QNetworkRequest req(QUrl("http://PC-1:9000/temp/" + uuid + ".mp4"));
    req.setHeader(QNetworkRequest::ContentTypeHeader, "video/mp4");
    // 监听上传进度
    connect(reply, &QNetworkReply::uploadProgress, ...);
    manager->put(req, file);
    ```

#### 步骤 2: 通知服务端发布 (POST)
只有当步骤 1 返回 **HTTP 200** 后，才执行此步。

*   **Endpoint**: `POST /api/video/publish`
*   **Body**:
    ```json
    {
        "title": "我的生活Vlog",
        // 这里必须填步骤 1 中构造的完整 URL
        "url": "http://PC-1:9000/temp/{UUID}.mp4"
    }
    ```
*   **UI 反馈**: 收到 200 后，提示“发布成功，转码中”，并关闭发布页面。不要让用户傻等转码完成。

---

## 3. Qt/QML 架构建议 (Architecture)

### 3.1 目录结构推荐
```text
Client/
├── main.cpp
├── config/
│   ├── ConfigManager.h  (单例：读取 config.json)
│   └── NetworkClient.h  (单例：管理 QNetworkAccessManager)
├── model/
│   ├── VideoModel.h     (继承 QAbstractListModel，绑定 Feed 数据)
│   └── UserContext.h    (单例：存储当前登录用户信息、Token)
├── view/
│   ├── LoginWindow.qml
│   ├── MainWindow.qml
│   └── components/
│       ├── VideoDelegate.qml (视频流卡片)
│       └── PlayerView.qml    (封装 MediaPlayer)
└── assets/
```

### 3.2 视频流性能优化 (List & Delegate)
在 `ListView` 中加载大量视频时：
1.  **Delegate 生命周期**: 确保 `VideoDelegate.qml` 在滑出屏幕时（`Component.onDestruction` 或 `ListView.isCurrentItem` 变为 false）**停止播放**并释放资源。
2.  **封面占位**: 视频未加载前 (`MediaPlayer.status !== Loaded`)，必须显示 `cover_url` 图片。
3.  **内存管理**: 只有当前可见的 Item 才创建 `MediaPlayer`，不可见的 Item 只显示图片。

---

## 4. 常见错误速查 (Checklist)

1.  **发布失败 (400 Bad Request)**:
    *   检查 JSON 里的 keys 是否拼写正确 (`title`, `url`)。
    *   检查 `url` 字段是否是以 `http://...` 开头的完整路径。

2.  **发布失败 (MinIO 403 Forbidden)**:
    *   检查 MinIO `temp` 桶权限。
    *   检查 URL 中是否包含了非法字符（文件名尽量只用 UUID）。

3.  **视频无法播放 (Format Not Supported)**:
    *   Qt 6 在 Linux 下极度依赖系统 FFmpeg。
    *   请在终端运行 `ffplay <CDN_URL>` 测试流是否正常。
    *   如果是 Windows，请确保安装了 LAV Filters。

4.  **关注/点赞无反应**:
    *   检查是否发送了 Token。
    *   检查是否正确处理了 JSON boolean 类型 (Qt `QJsonValue::Bool`)。