# 乐拍视界 (LePai Vision) · 客户端集成开发指南

**版本**: v1.0  
**适用对象**: Qt/C++/QML 客户端开发人员  
**更新日期**: 2026-01-09

---

## 1. 核心架构：你需要知道的 "三驾马车"

与传统的单体服务器不同，乐拍视界采用了分布式架构。作为客户端开发者，你需要意识到你的请求会发往 **三个不同的地址**。请务必在你的 `ConfigManager` 中区分它们：

1.  **API 网关 (The Brain)** - `PC-2`
    *   **职责**: 所有的业务逻辑（登录、注册、获取视频列表、提交发布申请）。
    *   **协议**: HTTP / JSON。
    *   **端口**: `8000` (Nginx转发) 或 `8080`。

2.  **对象存储 (The Vault)** - `PC-1`
    *   **职责**: **上传** 原始视频文件。
    *   **协议**: HTTP PUT (MinIO)。
    *   **端口**: `9000`。

3.  **CDN 分发 (The Muscle)** - `PC-3`
    *   **职责**: **播放** 视频、加载封面图。
    *   **协议**: HTTP GET (Nginx 静态文件服务)。
    *   **端口**: `8001`。

---

## 2. 配置文件标准

为了适应开发环境（单机）和部署环境（三机）的切换，**严禁在代码中硬编码 IP 地址**。请读取 `config.json`：

```json
{
    "api_base_url": "http://192.168.1.X:8000",   // 指向 PC-2
    "upload_base_url": "http://192.168.1.Y:9000", // 指向 PC-1
    "cdn_base_url": "http://192.168.1.Z:8001"     // 指向 PC-3
}
```

---

## 3. 鉴权机制 (Auth)

我们使用 **JWT (JSON Web Token)** 进行鉴权。

1.  **获取 Token**: 登录成功后，服务器会返回 `token` 字段。
2.  **存储 Token**: 客户端需在本地（如 `QSettings` 或 `SQLite`）持久化存储该 Token。
3.  **使用 Token**: 除登录/注册外的所有 API 请求，必须在 HTTP Header 中携带：

```text
Authorization: Bearer <你的Token字符串>
```

**Qt 代码示例**:
```cpp
QNetworkRequest request(url);
request.setRawHeader("Content-Type", "application/json");
// 注意 Bearer 后面的空格
QString authHeader = "Bearer " + ConfigManager::instance().getToken();
request.setRawHeader("Authorization", authHeader.toUtf8());
```

---

## 4. 核心业务流程与 API

### 4.1 用户体系

#### 注册 (Register)
*   **URL**: `/api/user/register` (POST)
*   **Body**: `{"username": "abc", "password": "123"}`
*   **Response**: `200 OK` (成功) 或 `400 Bad Request` (失败)。

#### 登录 (Login)
*   **URL**: `/api/user/login` (POST)
*   **Body**: `{"username": "abc", "password": "123"}`
*   **Response**:
    ```json
    {
        "code": 200,
        "message": "Login successful",
        "token": "eyJhbGciOi...",  // <--- 务必保存这个!
        "user": {
            "id": "uuid-...",
            "username": "abc",
            "createdAt": "..."
        }
    }
    ```

---

### 4.2 视频发布流程 (重点 & 难点)

视频发布是一个 **两阶段 (Two-Step)** 过程，为了减轻 API 服务器压力，客户端直接直传 MinIO。

#### 步骤 1: 上传原始文件 (MinIO PUT)
*   **动作**: 客户端直接将文件 PUT 到 MinIO 的 `temp` 桶。
*   **URL 构造规则**: `Config.upload_base_url + "/temp/" + FileName`
*   **建议**: `FileName` 建议使用 UUID + `.mp4`，避免重名覆盖。
*   **Qt 实现**:
    ```cpp
    // 不需要 QHttpMultiPart，直接 PUT 文件流
    QFile *file = new QFile("local_video.mp4");
    file->open(QIODevice::ReadOnly);
    
    QNetworkRequest request(QUrl("http://PC1_IP:9000/temp/my_uuid.mp4"));
    request.setRawHeader("Content-Type", "video/mp4");
    
    // 使用 PUT
    QNetworkReply *reply = manager->put(request, file);
    ```

#### 步骤 2: 提交发布任务 (Notify API)
*   **前提**: 步骤 1 的 `reply` 返回 `Finished` 且无错误。
*   **URL**: `/api/video/publish` (POST)
*   **Header**: 需要 Token。
*   **Body**:
    ```json
    {
        "title": "我的第一条视频",
        "url": "http://PC1_IP:9000/temp/my_uuid.mp4" // 步骤1中你使用的完整URL
    }
    ```
*   **后端逻辑**: 此时服务器会返回 `200 OK`，并启动后台转码。**注意：视频不会立即出现在列表中，需要等待几秒钟转码完成。**

---

### 4.3 视频流 (Feed)

#### 获取首页列表
*   **URL**: `/api/feed/discovery` (GET)
*   **参数**: `limit=10` (每页数量), `offset=0` (偏移量)。
*   **Header**: 可选。带 Token 会返回 `is_liked` 状态，不带则是游客模式。
*   **Response**:
    ```json
    {
        "code": 200,
        "data": [
            {
                "id": "vid-123",
                "title": "Qt Quick 教程",
                "url": "http://PC3_IP:8001/public/covers/vid-123.mp4", // CDN 地址
                "cover_url": "http://PC3_IP:8001/public/covers/vid-123.jpg",
                "author": "lan",
                "like_count": 99,
                "is_liked": false
            }
        ],
        "next_offset": 10
    }
    ```

---

## 5. Qt/QML 开发注意事项

### 5.1 播放器 (QML Video / MediaPlayer)
后端返回的 `url` 已经是 CDN 地址（指向 PC-3）。
*   **关键点**: QML 的 `MediaPlayer` 支持流式播放，直接将 `url` 赋值给 `source` 属性即可。
*   **坑**: 确保运行客户端的机器能 ping 通 PC-3 的 IP，否则无法加载视频。

### 5.2 网络模块封装
建议封装一个单例 `NetworkManager`。
*   **不要在主线程阻塞**: `QNetworkAccessManager` 是异步的，利用 `finished` 信号。不要使用 `QEventLoop` 强行阻塞等待，这会卡死 UI。
*   **JSON 处理**: 使用 `QJsonDocument`, `QJsonObject`, `QJsonArray`。

### 5.3 数据模型 (Model/View)
*   对于视频列表，建议继承 `QAbstractListModel`，将 API 返回的 JSON 数组解析为 C++ 的 `QList<VideoStruct>`，然后在 QML 中使用 `ListView` + `Delegate` 进行渲染。
*   实现 `canFetchMore()` 和 `fetchMore()` 来处理滑动到底部自动加载下一页 (`offset += limit`)。

### 5.4 错误处理规范
后端返回的 HTTP 状态码含义：
*   `200`: 成功。
*   `400`: 客户端参数错误（如 JSON 缺字段）。
*   `401`: Token 无效或过期（需跳转回登录页）。
*   `403`: MinIO 权限拒绝（可能是 MinIO 配置脚本没跑）。
*   `500`: 服务端内部错误（请联系后端开发看日志）。

---

## 6. 联调 Checklist

在报告 Bug 之前，请先检查：
1.  [ ] `config.json` 里的 IP 是否都是局域网真实 IP（非 127.0.0.1）？
2.  [ ] 三台服务器容器是否都已启动 (`docker ps`)？
3.  [ ] 是否运行过 `setup_minio_buckets.sh` (解决 403 问题)？
4.  [ ] 如果视频无法播放，尝试将 `url` 复制到浏览器中，看能否下载/播放？
5.  [ ] API 请求是否带上了 `Bearer ` 前缀？