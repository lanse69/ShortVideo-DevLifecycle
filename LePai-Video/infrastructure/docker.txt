# ==========================================
# 常用运维命令速查表
# ==========================================

# --- 启动服务 ---
# 启动所有服务（后台运行）
sudo docker-compose up -d

# 只启动基础设施 (数据库, Redis, MinIO)
sudo docker-compose --profile infra up -d

# --- 查看状态与日志 ---
# 查看所有容器状态
sudo docker-compose ps

# 查看特定容器日志 (从库)
sudo docker logs -f lepai_pg_slave

# 查看 API 网关日志
sudo docker logs -f lepai_gateway

# --- 数据库操作 ---
# 进入主库 SQL 终端
sudo docker exec -it lepai_pg psql -U lepai_admin -d lepai_db

# 检查主从同步状态 (在主库中运行)
sudo docker exec lepai_pg psql -U lepai_admin -d lepai_db -c "select * from pg_stat_replication;"

# --- 重置环境 (修改 init.sql 后必做) ---
# 警告：这将删除所有数据！

# 第一步：停止服务并删除容器、网络和关联卷
cd infrastructure
sudo docker-compose down -v --remove-orphans

# 第二步：假如第一步报错，手动强制删除特定容器
sudo docker rm -f lepai_pg lepai_pg_slave lepai_redis lepai_minio lepai_gateway lepai_cdn

# 第三步：手动清理残留的卷
sudo docker volume rm infrastructure_pg_master_data
sudo docker volume rm infrastructure_pg_slave_data
sudo docker volume rm infrastructure_redis_data
sudo docker volume rm infrastructure_minio_data

# 第四步：清理未使用的卷碎片
sudo docker volume prune -f

# --- 验证清理结果 ---
# 应该看不到任何 lepai 相关的容器
sudo docker ps -a | grep lepai

# 应该看不到任何 infrastructure 相关的卷
sudo docker volume ls | grep infrastructure
